# PostgreSQL configuration optimized for contact list performance
# Target: <150ms p95 for 100K+ contact queries

# Memory Settings (adjust based on available RAM)
shared_buffers = 256MB                    # 25% of RAM for dedicated server
effective_cache_size = 1GB                # 75% of available RAM
work_mem = 8MB                            # Per-connection memory for sorts/hashes
maintenance_work_mem = 64MB               # For VACUUM, CREATE INDEX, etc.
max_wal_size = 1GB
min_wal_size = 80MB

# Connection Settings
max_connections = 200                     # Adjust based on connection pool size
superuser_reserved_connections = 3

# Query Planner Settings
random_page_cost = 1.1                    # SSD storage (lower than default 4.0)
effective_io_concurrency = 200           # SSD concurrent I/O operations
seq_page_cost = 1                         # Sequential scan cost

# Checkpoint Settings (for write performance)
checkpoint_segments = 32                  # More WAL segments
checkpoint_completion_target = 0.7        # Spread checkpoint I/O
wal_buffers = 16MB

# Logging for performance monitoring
log_min_duration_statement = 150          # Log queries slower than 150ms (PRD requirement)
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'ddl'                     # Log DDL for index changes
log_line_prefix = '[%t] %u@%d %p '       # Include timestamp, user, database, PID

# Auto vacuum settings for high-volume tables
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s                  # Check tables every 30 seconds
autovacuum_vacuum_threshold = 50          # Minimum tuples before vacuum
autovacuum_analyze_threshold = 50         # Minimum tuples before analyze
autovacuum_vacuum_scale_factor = 0.1      # 10% of table size (more aggressive)
autovacuum_analyze_scale_factor = 0.05    # 5% of table size (more aggressive)

# Statistics collection for query optimization
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl
stats_temp_directory = 'pg_stat_tmp'

# Contact-specific optimizations
default_statistics_target = 100          # Higher statistics for better query plans

# Extension settings
shared_preload_libraries = 'pg_stat_statements, pg_trgm'

# pg_stat_statements settings for query analysis
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# Locale settings for Korean text support
lc_messages = 'en_US.UTF-8'
lc_monetary = 'ko_KR.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'ko_KR.UTF-8'

# Time zone
timezone = 'Asia/Seoul'

# Security settings
ssl = off                                 # Enable in production
password_encryption = scram-sha-256

# Additional performance settings for contact search
enable_seqscan = on                      # Allow sequential scans when appropriate
enable_indexscan = on                    # Allow index scans
enable_bitmapscan = on                   # Allow bitmap scans for multiple conditions
enable_hashjoin = on                     # Allow hash joins for tag filtering
enable_mergejoin = on                    # Allow merge joins
enable_nestloop = on                     # Allow nested loop joins

# Parallel query settings (PostgreSQL 9.6+)
max_parallel_workers_per_gather = 4     # Parallel workers for queries
max_parallel_workers = 8                # Total parallel workers
parallel_setup_cost = 1000              # Cost threshold for parallel queries
parallel_tuple_cost = 0.1               # Per-tuple cost for parallel processing